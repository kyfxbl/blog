title: 管理版本分支
date: 2013-09-24 11:32
categories: 研发管理
---
本文介绍一下镜像环境的作用，以及版本发布的一些策略
<!--more-->
 
# 镜像环境 

所谓镜像环境，是指跟生产环境完全一致的一套环境，包括代码、数据、配置文件等。镜像环境的作用是用于定位、解决生产环境的问题，或者用于生产环境升级前的验证 

当项目实际运行中发现了一个BUG，开发人员就需要一个环境来重现、定位问题。但是一般来说，不能直接在生产环境上进行定位，以免对业务造成影响。另一方面，如果开发环境的代码和生产环境不一致的话，又无法准确快速地重现、定位问题。所以，镜像环境对系统运维来说，是十分重要的 

对于集中部署的WEB应用，或许一套镜像环境就足够了，当然也不一定，根据实际需要，可以搭建任意数量的镜像环境 

对于不是集中部署的应用，一般来说需要多套镜像环境。比如说一个系统，假设在局点A和局点B分别部署，那么开发人员就需要有2套镜像环境，分别用来支撑局点A和局点B的运维 

# 代码分支 

代码分支（branch），指的不只是代码，也还包括数据库脚本、配置文件等。代码分支是一把双刃剑，在某些情况下会给开发带来便利，但同时也可能存在很大的维护隐患 

举例而言，比如一个项目开发基本完成，处于测试阶段。这个时候在现场有一些定制的需求，那么这种情况怎么办？ 

如果直接在主干版本上进行定制需求的开发，风险是比较大的。因为这个时候主干版本还处于测试阶段，尚未稳定，所以这个时候在主干上合入定制需求的代码，就有可能发生代码和进度冲突的情况。在这种情况下，从主干版本上拉出一个分支，不失为解决问题的一种方法。拉出分支之后，主干版本可以继续进行问题的修改，按照原定的时间表转测试。分支版本上可以进行定制需求新代码的开发，开发完成之后发布到现场 

但是，分支版本存在的生命周期一般来说不宜太长。还是用上面的场景作为例子，当主干版本通过测试，已经稳定下来以后，就应该启动定制需求的收编工作，将定制需求的代码合入主干版本中，然后用主干版本替换掉现场的分支版本 

因为如果长期同时存在2个版本，随着时间的推移，2套代码就会渐行渐远，到那个时候再进行收编，难度就会非常大，甚至成为不可能完成的任务。总结来说，分支版本存在的时间越长，收编时就需要花费越大的成本。分支版本存在时间太长，除了合并的难度会增大之外，还有一个弊端，就是会增大维护的工作量。在分支版本上发现的BUG，除了需要在分支版本上修改之外，也需要合到主干版本中（这个步骤由于分支代码和主干代码不尽相同，并不是一件很容易的事情），因为以后是需要用主干版本替换分支版本的，如果这时候不合入，那替换的时候，曾经解决的问题就又会重现 

总的来说，主干版本和分支版本并存，就需要同时维护2套代码，也就是一个BUG需要在两处修改，维护的工作量相当于是翻倍了 

# 版本火车的发布策略 

版本火车是指有计划地按批次发布版本，类似于火车的一节节车厢 

比如现场提了30个需求，开发人员首先对工作量和开发能力进行评估，然后结合需求的紧急程度，制定出版本发布的计划。比如1月1日交付最紧急的6个需求，然后2月1日交付次要的工作量较小的14个需求，最后在3月1日交付剩余的10个需求 

这个和第一点提到的镜像环境有关联。比如1月1日交付了第一批需求之后，研发就需要建立起现场的镜像环境，来定位解决现场发现的BUG，如果之后往现场发布了补丁，镜像环境也需要保持同步更新，总之要保证镜像环境和现场环境的高度一致，这样才方便定位问题 

在这个时候，现场跑的代码是代码11，镜像环境也是代码11。开发人员继续在代码11上进行开发（因为后续还要交付代码21），但是镜像环境必须保持稳定，始终保持与现场代码的一致。否则现场发现了一个BUG提交回来，家里的代码已经不一致了，就无法准确的重现及定位问题 

然后到了2月1日，将代码21交付到现场之后，家里的镜像环境也需要同步更新到代码21。然后开发人员可以继续在代码21的基础上进行代码31的开发 

# 升级的方式 

升级的方式有两种 

## 全量覆盖

比较简单的是全量安装。即每次都将系统的全量安装包发布到现场，现场进行全新安装。这种方式的成本是比较低的，因为不需要考虑升级包的制作，每次装新的就可以了，维护的工作量比较小。不过实际中，这种方式一般是不可行的，因为在两次版本发布之间，现场的系统已经运行了一段时间，肯定已经有大量的业务数据存在，全新安装可能会对业务数据造成破坏，这是不可接受的。当然可以用数据导入导出的方式来进行规避，不过这样就需要对数据进行额外的处理，也是需要工作量的。并且如果2个版本的数据库表结构有变化的话，要进行简单的导入导出就比较困难了 

## 增量补丁

另外一种方式是提供增量补丁。即每次制作升级包，将升级包发布到现场，现场不需要重新安装应用，只需要运行升级包，对应用进行升级。这种方式就需要每次制作一个升级包，将两次版本之间的差异（包括二进制文件、配置文件、数据库脚本、初始化数据等）提取出来 

如果多次发布升级包，一般还要考虑把前面的升级包内容，放到后面的升级包里，即所谓的全量升级包。比如说，1月份发布了一个升级包，2月份发布的升级包里，应该把1月份的升级包内容合进来。这样的话，如果需要再搭一套环境，就可以直接跑2月份的升级包，不需要先跑1月份的，再跑2月份的 

此外，制作升级包的时候，一般需要考虑升级脚本的容错性、可回滚、可重复执行等